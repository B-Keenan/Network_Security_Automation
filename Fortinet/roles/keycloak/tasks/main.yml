---
- name: Just-In-Time Credential Retrieval
  ansible.builtin.uri:
    url: "http://keycloak.awx.svc.cluster.local:8080/realms/awx-realm/protocol/openid-connect/token"
    method: POST
    body_format: form-urlencoded
    body:
      grant_type: "client_credentials"
      client_id: "awx-client"
      client_secret: "MrFSYIRzzqQVNlcmhfNgy9Q4ohsKSObs"
      status_code: 200
  register: token_response

- name: Set access token
  set_fact:
    access_token: "{{ token_response.json.access_token }}"

- name: Get list of groups from Keycloak
  ansible.builtin.uri:
    url: "http://keycloak.awx.svc.cluster.local:8080/admin/realms/awx-realm/groups"
    method: GET
    headers:
      Authorization: "Bearer {{ access_token }}"
    status_code: 200
  register: groups_response

- name: Determine Keycloak group name based on target context
  set_fact:
    keycloak_group_name: >
      {% if awx_single_hosts_run is defined and awx_single_hosts_run | length > 0 %}
        {{ groups | dict2items | selectattr('value', 'contains', awx_single_hosts_run) | map(attribute='key') | default([]) | first | default('') }}
      {% elif awx_hosts_vendor_selection is defined and awx_hosts_vendor_selection | length > 0 %}
        {{ awx_hosts_vendor_selection | first }}
      {% else %}
        {{ '' }}
      {% endif %}

- name: Fail if no group name is determined
  fail:
    msg: "No valid Keycloak group name determined. Ensure awx_single_hosts_run or awx_hosts_vendor_selection is provided."
  when: keycloak_group_name | length == 0

- name: Extract group ID for specified group
  set_fact:
    group_id: "{{ (groups_response.json | selectattr('name', 'equalto', keycloak_group_name) | first).id }}"

- name: Get user attributes from Keycloak group
  ansible.builtin.uri:
    url: "http://keycloak.awx.svc.cluster.local:8080/admin/realms/awx-realm/groups/{{ group_id }}"
    method: GET
    headers:
      Authorization: "Bearer {{ access_token }}"
    status_code: 200
  register: user_response

- name: Set credentials as hostvars for targeted hosts
  set_fact:
    credentials: "{{ credentials | default({}) | combine({item: {'ansible_user': user_response.json.attributes['host_' + item + '_username'][0], 'ansible_password': user_response.json.attributes['host_' + item + '_password'][0]}}) }}"
  loop: "{{ ansible_play_hosts_all }}"
  when: "'host_' + item + '_username' in user_response.json.attributes and 'host_' + item + '_password' in user_response.json.attributes"